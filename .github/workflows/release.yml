# 构建发布平台适配文件
# 流程：push tag → 创建 draft release → 各 job 并行构建上传 → 手动到 GitHub Releases 发布
name: release-sectool-adapter
on:
    push:
        tags:
            - "v*.*.*"
    workflow_dispatch:

# 同一个 tag 只允许一个 release 流程运行，后触发的会自动取消前一个
permissions:
    contents: write

concurrency:
    group: release-${{ github.ref }}
    cancel-in-progress: true

jobs:
    # 先创建 draft release，后续 job 往这个 release 上传 assets
    create-release:
        runs-on: ubuntu-latest
        outputs:
            release_id: ${{ steps.create.outputs.id }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Create Draft Release
              id: create
              uses: softprops/action-gh-release@v2
              with:
                  draft: true
                  generate_release_notes: true

    # 构建浏览器扩展 + Web
    browser-extensions:
        needs: create-release
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - uses: pnpm/action-setup@v4
              name: Install pnpm
              with:
                  version: 10
                  run_install: false

            - name: Setup pnpm cache
              uses: actions/cache@v4
              with:
                  path: ~/.local/share/pnpm/store
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-

            - name: Install dependencies
              run: pnpm install

            - name: Build core
              run: pnpm run build
              env:
                  NODE_OPTIONS: "--max_old_space_size=4096"

            - name: Release browser extensions + uTools
              run: |
                  node release.cjs init
                  pnpm --filter sectool-adapter-chrome run platform-release
                  pnpm --filter sectool-adapter-edge run platform-release
                  pnpm --filter sectool-adapter-firefox run platform-release
                  pnpm --filter sectool-adapter-web run platform-release
                  pnpm --filter sectool-adapter-utools run platform-release
                  ls -lh ./_release/
                  node release.cjs get

            - name: Get Release Files
              uses: edwardgeorge/file-outputs-action@main
              id: get_release_files
              with:
                  files: files=_release_files

            - name: Upload Assets
              uses: softprops/action-gh-release@v2
              with:
                  draft: true
                  files: |
                      ${{ steps.get_release_files.outputs.files }}

    # 构建 Tauri 桌面端（macOS + Windows + Linux）
    tauri-desktop:
        needs: create-release
        strategy:
            fail-fast: false
            matrix:
                include:
                    - platform: macos-latest
                      target: aarch64-apple-darwin
                    - platform: macos-latest
                      target: x86_64-apple-darwin
                    - platform: windows-latest
                      target: x86_64-pc-windows-msvc
                    - platform: ubuntu-22.04
                      target: x86_64-unknown-linux-gnu

        runs-on: ${{ matrix.platform }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - uses: pnpm/action-setup@v4
              name: Install pnpm
              with:
                  version: 10
                  run_install: false

            - name: Setup pnpm cache
              uses: actions/cache@v4
              with:
                  path: ~/.local/share/pnpm/store
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-

            - name: Install Linux dependencies
              if: runner.os == 'Linux'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget file libxdo-dev libssl-dev libayatana-appindicator3-dev librsvg2-dev

            - name: Install dependencies
              run: pnpm install

            - name: Install Rust stable
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            - name: Rust cache
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: packages/sectool-adapter/tauri/src-tauri

            - name: Build core
              run: pnpm run build
              env:
                  NODE_OPTIONS: "--max_old_space_size=4096"

            - name: Build Tauri desktop
              shell: bash
              run: |
                  pnpm run initialize
                  node release.cjs init
                  pnpm --filter sectool-adapter-tauri run platform-release
                  ls ./_release/
                  node release.cjs get
              env:
                  TAURI_TARGET: ${{ matrix.target }}

            - name: Get Release Files
              uses: edwardgeorge/file-outputs-action@main
              id: get_release_files
              with:
                  files: files=_release_files

            - name: Upload Assets
              uses: softprops/action-gh-release@v2
              with:
                  draft: true
                  files: |
                      ${{ steps.get_release_files.outputs.files }}
